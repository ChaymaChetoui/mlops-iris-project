name: CI/CD

on:
  push:
    branches: [ dev, main ]
  pull_request:
    branches: [ dev, main ]
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight (for CT smoke test)

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install flake8 pytest
      - name: Lint with flake8
        run: flake8 src/ --max-line-length=120
      - name: Run tests
        run: pytest tests/ -v

  build-docker:
    needs: lint-and-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push Docker image
        run: |
          IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/mlops-iris-project:latest
          docker build -t $IMAGE_NAME .
          docker push $IMAGE_NAME

  smoke-test:
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: pip install -r requirements.txt scikit-learn
      - name: Smoke test training
        run: |
          python -c "from sklearn.datasets import load_iris; from sklearn.linear_model import LogisticRegression; from sklearn.model_selection import train_test_split; iris=load_iris(); X_train, X_test, y_train, y_test = train_test_split(iris.data, iris.target, test_size=0.2, random_state=42); model=LogisticRegression(max_iter=50); model.fit(X_train, y_train); acc=model.score(X_test, y_test); print('Smoke test accuracy:', acc); assert acc > 0.8"